apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: wazuh
  namespace: argocd
spec:
  project: default
  source:
    repoURL: 'https://morgoved.github.io/wazuh-helm/' #
    chart: wazuh
    targetRevision: 1.0.15 # Check for latest stable version
    helm:
        values: |
          agent:
            enabled: true
            kind: DaemonSet
            nodeSelector:
              node-role.kubernetes.io/control-plane: "true"
            tolerations:
              - key: "node-role.kubernetes.io/control-plane"
                operator: "Exists"
                effect: "NoSchedule"
            resources:
              requests:
                cpu: 200m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi
            extraEnvVars:
              - name: WAZUH_REGISTRATION_SERVER
                value: "wazuh-manager-master"
              - name: WAZUH_GROUP
                value: "k3s-nodes"
          indexer:
            replicas: 1
            images:
              resources:
                requests:
                  cpu: 700m
                  memory: 1Gi
                limits:
                  memory: 1Gi
            storageSize: 10Gi 
            storageClass: "local-path"
          wazuh:
            master:
              storageClass: "local-path"
              storageSize: 15Gi
              additionalVolumes:
                - name: wazuh-runtime-rules
                  configMap:
                    name: wazuh-runtime-rules
              additionalVolumeMounts:
                - name: wazuh-runtime-rules
                  mountPath: /var/ossec/etc/rules/110-k8s-audit.xml
                  subPath: 110-k8s-audit.xml
                  readOnly: true
            manager:
              storageClass: "local-path"
              storageSize: 5Gi
            worker:
              replicas: 1
              storageClass: "local-path"
              storageSize: 5Gi
            images:
              resources:
                requests:
                  cpu: 700m
                  memory: 7500Mi
                limits:
                  memory: 1Gi
              worker_resources:
                requests:
                  cpu: 1000m
                  memory: 1Gi
                limits:
                  memory: 1Gi
          dashboard:
            service:
              type: NodePort
              port: 5601
              nodePort: 30443

          ingress:
            enabled: false
      # Custom values for Wazuh deployment
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: wazuh
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true